<project name="backup">

  <target name="backup" depends="db-dump, backup-custom-modules, backup-custom-themes" />

  <target name="dump">
    <property name="env.backup.db.dir" value="${project.drupal.dir}" override="true" />
    <phingcall target="backup-database">
      <property name="link_backup" value="true" />
    </phingcall>
    <phingcall target="slack-message">
      <property name="slack.text" value="You can download new database dump here: ${project.production_url}/${backup_name}.gz" override="true" />
    </phingcall>
  </target>

  <target name="db-dump" depends="backup-dir-init">
    <property name="env.backup.db.dir" value="${project.drupal.dir}" override="true" />
    <phingcall target="backup-database" />
  </target>

  <target name="backup-database">
    <phingcall target="cc"/>
    <tstamp />
    <property name="backup_name" value="${DSTAMP}-${TSTAMP}.sql" />
    <drush command="sql-dump" assume="yes">
      <option name="root">${project.drupal.dir}</option>
      <option name="gzip"></option>
      <option name="result-file">${env.backup.db.dir}/${backup_name}</option>
    </drush>
    <if>
      <equals arg1="${link_backup}" arg2="1" />
      <then>
        <exec command="ln -sf ${env.backup.db.dir}/${backup_name}.gz ${project.drupal.dir}/dump.sql.gz" passthru="false" />
      </then>
    </if>
  </target>

  <target name="backup-custom-modules" depends="backup-dir-init">
    <phingcall target="delete-folder">
      <property name="folder.deletable" value="${env.backup.dir}/modules/custom" />
    </phingcall>
    <copy todir="${env.backup.dir}/modules/custom">
      <fileset dir="${project.drupal.custom.dir}">
        <include name="**"/>
      </fileset>
    </copy>
  </target>

  <target name="backup-features-modules" depends="backup-dir-init">
    <phingcall target="delete-folder">
      <property name="folder.deletable" value="${env.backup.dir}/modules/features" />
    </phingcall>
    <copy todir="${env.backup.dir}/modules/features">
      <fileset dir="${project.drupal.features.dir}">
        <include name="**"/>
      </fileset>
    </copy>
  </target>

  <target name="backup-custom-themes" depends="backup-dir-init">
    <phingcall target="delete-folder">
      <property name="folder.deletable" value="${env.backup.dir}/themes" />
    </phingcall>
    <copy todir="${env.backup.dir}/themes">
      <fileset dir="${project.drupal.theme.dir}">
        <include name="**"/>
      </fileset>
    </copy>
  </target>

  <target name="backup-project-files" depends="backup-dir-init">
    <phingcall target="delete-folder">
      <property name="folder.deletable" value="${env.backup.dir}/files" />
    </phingcall>
    <copy todir="${env.backup.dir}/files">
      <fileset dir="${project.drupal.files.dir}">
        <include name="**"/>
        <exclude name="styles/**"/>
      </fileset>
    </copy>
  </target>

  <target name="backup-dir-init">
    <phingcall target="create-folder">
      <property name="folder.creatable" value="${env.backup.dir}" />
    </phingcall>
  </target>

  <target name="backup-nodes">
    <if>
      <available file="${env.backup.dir}/nodes/nodes" property="file_exists" />
      <then>
        <delete file="${env.backup.dir}/nodes/nodes" quiet="true" />
        <echo msg="Delete nodes backup file" />
      </then>
    </if>
    <drush command="node-export-export">
      <option name="root">${project.drupal.dir}</option>
      <param>--file=${env.backup.dir}/nodes/nodes</param>
      <param>--format=xml</param>
    </drush>
  </target>

</project>
